From: Audra Mitchell <audra@redhat.com>
Date: Wed, 18 Feb 2026 13:42:10 -0500
Subject: [PATCH] selftests/mm: fix soft-dirty kselftest supported check

On architectures with separate user address space, such as s390 or those
without an MMU, the call to __access_ok will return true.  The soft-dirty
test attempts to check if the PAGEMAP_SCAN feature is supported by
providing an invalid address and expecting __access_ok to return false,
thus throwing an EFAULT error on return.  Because of this assumption, this
check will always fail for the architectures aforementioned.  Update the
supported check to handle the return being zero for these types of cases.

Link: https://lkml.kernel.org/r/20260218184210.206466-1-audra@redhat.com
Signed-off-by: Audra Mitchell <audra@redhat.com>
Cc: David Hildenbrand <david@kernel.org>
Cc: Liam Howlett <liam.howlett@oracle.com>
Cc: Lorenzo Stoakes <lorenzo.stoakes@oracle.com>
Cc: Michal Hocko <mhocko@suse.com>
Cc: Mike Rapoport <rppt@kernel.org>
Cc: Shuah Khan <shuah@kernel.org>
Cc: Suren Baghdasaryan <surenb@google.com>
Cc: Vlastimil Babka <vbabka@kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
---
 tools/testing/selftests/mm/vm_util.c | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/tools/testing/selftests/mm/vm_util.c b/tools/testing/selftests/mm/vm_util.c
index a6d4ff7dfdc0f..9428f4d7bf55b 100644
--- a/tools/testing/selftests/mm/vm_util.c
+++ b/tools/testing/selftests/mm/vm_util.c
@@ -77,10 +77,8 @@ static bool pagemap_scan_supported(int fd, char *start)
 
 	/* Provide an invalid address in order to trigger EFAULT. */
 	ret = __pagemap_scan_get_categories(fd, start, (struct page_region *) ~0UL);
-	if (ret == 0)
-		ksft_exit_fail_msg("PAGEMAP_SCAN succeeded unexpectedly\n");
 
-	supported = errno == EFAULT;
+	supported = (ret == 0) || (errno == EFAULT);
 
 	return supported;
 }
-- 
2.47.3

