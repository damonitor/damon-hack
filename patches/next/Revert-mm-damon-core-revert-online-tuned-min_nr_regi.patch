From: SeongJae Park <sj@kernel.org>
Date: Sat, 14 Feb 2026 11:31:49 -0800
Subject: [PATCH] Revert "mm/damon/core: revert online-tuned min_nr_regions
 respect"

This reverts commit 43aff797a75ec07c2609975b3cfe9607a4a9c789.

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/core.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/mm/damon/core.c b/mm/damon/core.c
index 9582a9e21bc77..a2d7f17b6f696 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -2800,6 +2800,8 @@ static int kdamond_fn(void *data)
 		unsigned long next_aggregation_sis = ctx->next_aggregation_sis;
 		unsigned long next_ops_update_sis = ctx->next_ops_update_sis;
 		unsigned long sample_interval = ctx->attrs.sample_interval;
+		/* cache min_nr_regions; it can be changed in damon_call() */
+		unsigned long old_min_nr_regions = ctx->attrs.min_nr_regions;
 
 		if (kdamond_wait_activation(ctx))
 			break;
@@ -2875,6 +2877,10 @@ static int kdamond_fn(void *data)
 				ctx->ops.update(ctx);
 			sz_limit = kdamond_get_apply_max_region_sz(ctx);
 		}
+
+		/* damon_call() callers could updated min_nr_regions */
+		if (ctx->attrs.min_nr_regions != old_min_nr_regions)
+			sz_limit = kdamond_get_apply_max_region_sz(ctx);
 	}
 done:
 	damon_destroy_targets(ctx);
-- 
2.47.3

