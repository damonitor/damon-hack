From: SeongJae Park <sj@kernel.org>
Date: Mon, 16 Dec 2024 20:17:20 -0800
Subject: [PATCH] Revert "mm/damon/paddr: revert DAMOS_STAT_FULL support"

This reverts commit 1332a1acae5878a8d060378867e7a67f04fb530f.

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/paddr.c | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/mm/damon/paddr.c b/mm/damon/paddr.c
index 5197393bdcc1..0d97b9132317 100644
--- a/mm/damon/paddr.c
+++ b/mm/damon/paddr.c
@@ -488,6 +488,28 @@ static unsigned long damon_pa_migrate(struct damon_region *r, struct damos *s,
 	return applied * PAGE_SIZE;
 }
 
+static unsigned long damon_pa_stat_full(struct damon_region *r, struct damos *s,
+		unsigned long *sz_filter_passed)
+{
+	unsigned long addr, applied = 0;
+	LIST_HEAD(folio_list);
+
+	for (addr = r->ar.start; addr < r->ar.end; addr += PAGE_SIZE) {
+		struct folio *folio = damon_get_folio(PHYS_PFN(addr));
+
+		if (!folio)
+			continue;
+
+		if (damos_pa_filter_out(s, folio))
+			goto put_folio;
+		else
+			*sz_filter_passed += folio_size(folio);
+		applied += folio_size(folio);
+put_folio:
+		folio_put(folio);
+	}
+	return applied;
+}
 
 #ifdef CONFIG_ACMA
 
@@ -601,6 +623,8 @@ static unsigned long damon_pa_apply_scheme(struct damon_ctx *ctx,
 #endif
 	case DAMOS_STAT:
 		break;
+	case DAMOS_STAT_FULL:
+		return damon_pa_stat_full(r, scheme, sz_filter_passed);
 	default:
 		/* DAMOS actions that not yet supported by 'paddr'. */
 		break;
-- 
2.39.5

