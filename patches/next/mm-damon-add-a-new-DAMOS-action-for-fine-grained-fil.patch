From: SeongJae Park <sj@kernel.org>
Date: Fri, 6 Dec 2024 16:36:03 -0800
Subject: [PATCH] mm/damon: add a new DAMOS action for fine-grained
 filter-aware stat

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 include/linux/damon.h    |  1 +
 mm/damon/paddr.c         | 21 +++++++++++++++++++++
 mm/damon/sysfs-schemes.c |  1 +
 3 files changed, 23 insertions(+)

diff --git a/include/linux/damon.h b/include/linux/damon.h
index acedaab4dccf..19dd9cc2568f 100644
--- a/include/linux/damon.h
+++ b/include/linux/damon.h
@@ -136,6 +136,7 @@ enum damos_action {
 	DAMOS_FREE,
 #endif
 	DAMOS_STAT,		/* Do nothing but only record the stat */
+	DAMOS_STAT_FULL,	/* Handle and account filters */
 	NR_DAMOS_ACTIONS,
 };
 
diff --git a/mm/damon/paddr.c b/mm/damon/paddr.c
index b3cb2578a201..e6be2659f18c 100644
--- a/mm/damon/paddr.c
+++ b/mm/damon/paddr.c
@@ -477,6 +477,25 @@ static unsigned long damon_pa_migrate(struct damon_region *r, struct damos *s)
 	return applied * PAGE_SIZE;
 }
 
+static unsigned long damon_pa_stat_full(struct damon_region *r, struct damos *s)
+{
+	unsigned long addr, applied = 0;
+	LIST_HEAD(folio_list);
+
+	for (addr = r->ar.start; addr < r->ar.end; addr += PAGE_SIZE) {
+		struct folio *folio = damon_get_folio(PHYS_PFN(addr));
+
+		if (!folio)
+			continue;
+
+		if (damos_pa_filter_out(s, folio))
+			goto put_folio;
+		applied += folio_size(folio);
+put_folio:
+		folio_put(folio);
+	}
+	return applied;
+}
 
 #ifdef CONFIG_ACMA
 
@@ -587,6 +606,8 @@ static unsigned long damon_pa_apply_scheme(struct damon_ctx *ctx,
 #endif
 	case DAMOS_STAT:
 		break;
+	case DAMOS_STAT_FULL:
+		return damon_pa_stat_full(r, scheme);
 	default:
 		/* DAMOS actions that not yet supported by 'paddr'. */
 		break;
diff --git a/mm/damon/sysfs-schemes.c b/mm/damon/sysfs-schemes.c
index 5000d81d0d83..c91fc06fe2e6 100644
--- a/mm/damon/sysfs-schemes.c
+++ b/mm/damon/sysfs-schemes.c
@@ -1421,6 +1421,7 @@ static const char * const damon_sysfs_damos_action_strs[] = {
 	"damos_free",
 #endif
 	"stat",
+	"stat_full",
 };
 
 static struct damon_sysfs_scheme *damon_sysfs_scheme_alloc(
-- 
2.39.5

