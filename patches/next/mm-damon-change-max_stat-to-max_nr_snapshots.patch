From: SeongJae Park <sj@kernel.org>
Date: Sun, 23 Nov 2025 08:39:07 -0800
Subject: [PATCH] mm/damon: change max_stat to max_nr_snapshots

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 include/linux/damon.h    |   8 +-
 mm/damon/core.c          |  28 +------
 mm/damon/sysfs-schemes.c | 176 +--------------------------------------
 3 files changed, 9 insertions(+), 203 deletions(-)

diff --git a/include/linux/damon.h b/include/linux/damon.h
index d797d5700455..c338dc21e2c0 100644
--- a/include/linux/damon.h
+++ b/include/linux/damon.h
@@ -541,7 +541,7 @@ struct damos_migrate_dests {
  * @ops_filters:	ops layer handling &struct damos_filter objects list.
  * @last_applied:	Last @action applied ops-managing entity.
  * @stat:		Statistics of this scheme.
- * @max_stat:		Upper limit of stats.
+ * @max_nr_snapshots:	Upper limit of nr_snapshots stat.
  * @list:		List head for siblings.
  *
  * For each @apply_interval_us, DAMON finds regions which fit in the
@@ -589,8 +589,8 @@ struct damos_migrate_dests {
  *
  * After applying the &action to each region, &stat is updated.
  *
- * If any of updated stat exceeds that of &max_stats that is non-zero, the
- * scheme is deactivated.
+ * If &max_nr_snapshots is set and &stat.nr_snapsghots exceeds it, the scheme
+ * is deactivated.
  */
 struct damos {
 	struct damos_access_pattern pattern;
@@ -630,7 +630,7 @@ struct damos {
 	struct list_head ops_filters;
 	void *last_applied;
 	struct damos_stat stat;
-	struct damos_stat max_stat;
+	unsigned long max_nr_snapshots;
 	struct list_head list;
 };
 
diff --git a/mm/damon/core.c b/mm/damon/core.c
index d7f92ffae9f6..30e7ba7a9cb1 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -419,7 +419,7 @@ struct damos *damon_new_scheme(struct damos_access_pattern *pattern,
 	INIT_LIST_HEAD(&scheme->core_filters);
 	INIT_LIST_HEAD(&scheme->ops_filters);
 	scheme->stat = (struct damos_stat){};
-	scheme->max_stat = (struct damos_stat){};
+	scheme->max_nr_snapshots = 0;
 	INIT_LIST_HEAD(&scheme->list);
 
 	scheme->quota = *(damos_quota_init(quota));
@@ -1122,7 +1122,7 @@ static int damos_commit(struct damos *dst, struct damos *src)
 	if (err)
 		return err;
 
-	dst->max_stat = src->max_stat;
+	dst->max_nr_snapshots = src->max_nr_snapshots;
 	return 0;
 }
 
@@ -1793,27 +1793,6 @@ static bool damos_skip_charged_region(struct damon_target *t,
 	return false;
 }
 
-static bool damos_max_stat_exceeded(struct damos *s)
-{
-	if (s->max_stat.nr_tried && s->max_stat.nr_tried <= s->stat.nr_tried)
-		return true;
-	if (s->max_stat.sz_tried && s->max_stat.sz_tried <= s->stat.sz_tried)
-		return true;
-	if (s->max_stat.sz_tried &&
-			s->max_stat.nr_applied <= s->stat.nr_applied)
-		return true;
-	if (s->max_stat.sz_tried && s->max_stat.sz_ops_filter_passed <=
-			s->stat.sz_ops_filter_passed)
-		return true;
-	if (s->max_stat.sz_tried &&
-			s->max_stat.qt_exceeds <= s->stat.qt_exceeds)
-		return true;
-	if (s->max_stat.sz_tried &&
-			s->max_stat.nr_snapshots <= s->stat.nr_snapshots)
-		return true;
-	return false;
-}
-
 static void damos_update_stat(struct damos *s,
 		unsigned long sz_tried, unsigned long sz_applied,
 		unsigned long sz_ops_filter_passed)
@@ -2077,7 +2056,8 @@ static void damon_do_apply_schemes(struct damon_ctx *c,
 		if (damos_skip_charged_region(t, &r, s, c->min_sz_region))
 			continue;
 
-		if (damos_max_stat_exceeded(s))
+		if (s->max_nr_snapshots &&
+				s->max_nr_snapshots <= s->stat.nr_snapshots)
 			continue;
 
 		if (damos_valid_target(c, t, r, s))
diff --git a/mm/damon/sysfs-schemes.c b/mm/damon/sysfs-schemes.c
index c80e6f7e139f..710428330932 100644
--- a/mm/damon/sysfs-schemes.c
+++ b/mm/damon/sysfs-schemes.c
@@ -199,17 +199,11 @@ static const struct kobj_type damon_sysfs_scheme_regions_ktype = {
 struct damon_sysfs_stats {
 	struct kobject kobj;
 	unsigned long nr_tried;
-	unsigned long max_nr_tried;
 	unsigned long sz_tried;
-	unsigned long max_sz_tried;
 	unsigned long nr_applied;
-	unsigned long max_nr_applied;
 	unsigned long sz_applied;
-	unsigned long max_sz_applied;
 	unsigned long sz_ops_filter_passed;
-	unsigned long max_sz_ops_filter_passed;
 	unsigned long qt_exceeds;
-	unsigned long max_qt_exceeds;
 	unsigned long nr_snapshots;
 	unsigned long max_nr_snapshots;
 };
@@ -228,28 +222,6 @@ static ssize_t nr_tried_show(struct kobject *kobj, struct kobj_attribute *attr,
 	return sysfs_emit(buf, "%lu\n", stats->nr_tried);
 }
 
-static ssize_t max_nr_tried_show(struct kobject *kobj,
-		struct kobj_attribute *attr, char *buf)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-
-	return sysfs_emit(buf, "%lu\n", stats->max_nr_tried);
-}
-
-static ssize_t max_nr_tried_store(struct kobject *kobj,
-		struct kobj_attribute *attr, const char *buf, size_t count)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-	unsigned long max_nr_tried, err = kstrtoul(buf, 0, &max_nr_tried);
-
-	if (err)
-		return err;
-	stats->max_nr_tried = max_nr_tried;
-	return count;
-}
-
 static ssize_t sz_tried_show(struct kobject *kobj, struct kobj_attribute *attr,
 		char *buf)
 {
@@ -259,28 +231,6 @@ static ssize_t sz_tried_show(struct kobject *kobj, struct kobj_attribute *attr,
 	return sysfs_emit(buf, "%lu\n", stats->sz_tried);
 }
 
-static ssize_t max_sz_tried_show(struct kobject *kobj,
-		struct kobj_attribute *attr, char *buf)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-
-	return sysfs_emit(buf, "%lu\n", stats->max_sz_tried);
-}
-
-static ssize_t max_sz_tried_store(struct kobject *kobj,
-		struct kobj_attribute *attr, const char *buf, size_t count)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-	unsigned long max_sz_tried, err = kstrtoul(buf, 0, &max_sz_tried);
-
-	if (err)
-		return err;
-	stats->max_sz_tried = max_sz_tried;
-	return count;
-}
-
 static ssize_t nr_applied_show(struct kobject *kobj,
 		struct kobj_attribute *attr, char *buf)
 {
@@ -290,28 +240,6 @@ static ssize_t nr_applied_show(struct kobject *kobj,
 	return sysfs_emit(buf, "%lu\n", stats->nr_applied);
 }
 
-static ssize_t max_nr_applied_show(struct kobject *kobj,
-		struct kobj_attribute *attr, char *buf)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-
-	return sysfs_emit(buf, "%lu\n", stats->max_nr_applied);
-}
-
-static ssize_t max_nr_applied_store(struct kobject *kobj,
-		struct kobj_attribute *attr, const char *buf, size_t count)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-	unsigned long max_nr_applied, err = kstrtoul(buf, 0, &max_nr_applied);
-
-	if (err)
-		return err;
-	stats->max_nr_applied = max_nr_applied;
-	return count;
-}
-
 static ssize_t sz_applied_show(struct kobject *kobj,
 		struct kobj_attribute *attr, char *buf)
 {
@@ -321,28 +249,6 @@ static ssize_t sz_applied_show(struct kobject *kobj,
 	return sysfs_emit(buf, "%lu\n", stats->sz_applied);
 }
 
-static ssize_t max_sz_applied_show(struct kobject *kobj,
-		struct kobj_attribute *attr, char *buf)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-
-	return sysfs_emit(buf, "%lu\n", stats->max_sz_applied);
-}
-
-static ssize_t max_sz_applied_store(struct kobject *kobj,
-		struct kobj_attribute *attr, const char *buf, size_t count)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-	unsigned long max_sz_applied, err = kstrtoul(buf, 0, &max_sz_applied);
-
-	if (err)
-		return err;
-	stats->max_sz_applied = max_sz_applied;
-	return count;
-}
-
 static ssize_t sz_ops_filter_passed_show(struct kobject *kobj,
 		struct kobj_attribute *attr, char *buf)
 {
@@ -352,28 +258,6 @@ static ssize_t sz_ops_filter_passed_show(struct kobject *kobj,
 	return sysfs_emit(buf, "%lu\n", stats->sz_ops_filter_passed);
 }
 
-static ssize_t max_sz_ops_filter_passed_show(struct kobject *kobj,
-		struct kobj_attribute *attr, char *buf)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-
-	return sysfs_emit(buf, "%lu\n", stats->max_sz_ops_filter_passed);
-}
-
-static ssize_t max_sz_ops_filter_passed_store(struct kobject *kobj,
-		struct kobj_attribute *attr, const char *buf, size_t count)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-	unsigned long max_sz_ops_filter_passed, err = kstrtoul(buf, 0, &max_sz_ops_filter_passed);
-
-	if (err)
-		return err;
-	stats->max_sz_ops_filter_passed = max_sz_ops_filter_passed;
-	return count;
-}
-
 static ssize_t qt_exceeds_show(struct kobject *kobj,
 		struct kobj_attribute *attr, char *buf)
 {
@@ -383,28 +267,6 @@ static ssize_t qt_exceeds_show(struct kobject *kobj,
 	return sysfs_emit(buf, "%lu\n", stats->qt_exceeds);
 }
 
-static ssize_t max_qt_exceeds_show(struct kobject *kobj,
-		struct kobj_attribute *attr, char *buf)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-
-	return sysfs_emit(buf, "%lu\n", stats->max_qt_exceeds);
-}
-
-static ssize_t max_qt_exceeds_store(struct kobject *kobj,
-		struct kobj_attribute *attr, const char *buf, size_t count)
-{
-	struct damon_sysfs_stats *stats = container_of(kobj,
-			struct damon_sysfs_stats, kobj);
-	unsigned long max_qt_exceeds, err = kstrtoul(buf, 0, &max_qt_exceeds);
-
-	if (err)
-		return err;
-	stats->max_qt_exceeds = max_qt_exceeds;
-	return count;
-}
-
 static ssize_t nr_snapshots_show(struct kobject *kobj,
 		struct kobj_attribute *attr, char *buf)
 {
@@ -444,39 +306,21 @@ static void damon_sysfs_stats_release(struct kobject *kobj)
 static struct kobj_attribute damon_sysfs_stats_nr_tried_attr =
 		__ATTR_RO_MODE(nr_tried, 0400);
 
-static struct kobj_attribute damon_sysfs_stats_max_nr_tried_attr =
-		__ATTR_RW_MODE(max_nr_tried, 0600);
-
 static struct kobj_attribute damon_sysfs_stats_sz_tried_attr =
 		__ATTR_RO_MODE(sz_tried, 0400);
 
-static struct kobj_attribute damon_sysfs_stats_max_sz_tried_attr =
-		__ATTR_RW_MODE(max_sz_tried, 0600);
-
 static struct kobj_attribute damon_sysfs_stats_nr_applied_attr =
 		__ATTR_RO_MODE(nr_applied, 0400);
 
-static struct kobj_attribute damon_sysfs_stats_max_nr_applied_attr =
-		__ATTR_RW_MODE(max_nr_applied, 0600);
-
 static struct kobj_attribute damon_sysfs_stats_sz_applied_attr =
 		__ATTR_RO_MODE(sz_applied, 0400);
 
-static struct kobj_attribute damon_sysfs_stats_max_sz_applied_attr =
-		__ATTR_RW_MODE(max_sz_applied, 0600);
-
 static struct kobj_attribute damon_sysfs_stats_sz_ops_filter_passed_attr =
 		__ATTR_RO_MODE(sz_ops_filter_passed, 0400);
 
-static struct kobj_attribute damon_sysfs_stats_max_sz_ops_filter_passed_attr =
-		__ATTR_RW_MODE(max_sz_ops_filter_passed, 0600);
-
 static struct kobj_attribute damon_sysfs_stats_qt_exceeds_attr =
 		__ATTR_RO_MODE(qt_exceeds, 0400);
 
-static struct kobj_attribute damon_sysfs_stats_max_qt_exceeds_attr =
-		__ATTR_RW_MODE(max_qt_exceeds, 0600);
-
 static struct kobj_attribute damon_sysfs_stats_nr_snapshots_attr =
 		__ATTR_RO_MODE(nr_snapshots, 0400);
 
@@ -485,17 +329,11 @@ static struct kobj_attribute damon_sysfs_stats_max_nr_snapshots_attr =
 
 static struct attribute *damon_sysfs_stats_attrs[] = {
 	&damon_sysfs_stats_nr_tried_attr.attr,
-	&damon_sysfs_stats_max_nr_tried_attr.attr,
 	&damon_sysfs_stats_sz_tried_attr.attr,
-	&damon_sysfs_stats_max_sz_tried_attr.attr,
 	&damon_sysfs_stats_nr_applied_attr.attr,
-	&damon_sysfs_stats_max_nr_applied_attr.attr,
 	&damon_sysfs_stats_sz_applied_attr.attr,
-	&damon_sysfs_stats_max_sz_applied_attr.attr,
 	&damon_sysfs_stats_sz_ops_filter_passed_attr.attr,
-	&damon_sysfs_stats_max_sz_ops_filter_passed_attr.attr,
 	&damon_sysfs_stats_qt_exceeds_attr.attr,
-	&damon_sysfs_stats_max_qt_exceeds_attr.attr,
 	&damon_sysfs_stats_nr_snapshots_attr.attr,
 	&damon_sysfs_stats_max_nr_snapshots_attr.attr,
 	NULL,
@@ -2871,18 +2709,6 @@ static int damos_sysfs_add_migrate_dest(struct damos *scheme,
 	return 0;
 }
 
-static void damos_sysfs_set_max_stat(struct damos_stat *max_stat,
-		struct damon_sysfs_stats *sysfs_stats)
-{
-	max_stat->nr_tried = sysfs_stats->max_nr_tried;
-	max_stat->sz_tried = sysfs_stats->max_sz_tried;
-	max_stat->nr_applied = sysfs_stats->max_nr_applied;
-	max_stat->sz_applied = sysfs_stats->max_sz_applied;
-	max_stat->sz_ops_filter_passed = sysfs_stats->max_sz_ops_filter_passed;
-	max_stat->qt_exceeds = sysfs_stats->max_qt_exceeds;
-	max_stat->nr_snapshots = sysfs_stats->max_nr_snapshots;
-}
-
 static struct damos *damon_sysfs_mk_scheme(
 		struct damon_sysfs_scheme *sysfs_scheme)
 {
@@ -2950,7 +2776,7 @@ static struct damos *damon_sysfs_mk_scheme(
 		damon_destroy_scheme(scheme);
 		return NULL;
 	}
-	damos_sysfs_set_max_stat(&scheme->max_stat, sysfs_scheme->stats);
+	scheme->max_nr_snapshots = sysfs_scheme->stats->max_nr_snapshots;
 	return scheme;
 }
 
-- 
2.47.3

