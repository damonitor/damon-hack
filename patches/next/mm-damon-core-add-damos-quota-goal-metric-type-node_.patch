From: SeongJae Park <sj@kernel.org>
Date: Wed, 5 Mar 2025 19:45:02 -0800
Subject: [PATCH] mm/damon/core: add damos quota goal metric type node_util_bp

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 include/linux/damon.h    |  3 +++
 mm/damon/core.c          | 14 ++++++++++++++
 mm/damon/sysfs-schemes.c |  1 +
 3 files changed, 18 insertions(+)

diff --git a/include/linux/damon.h b/include/linux/damon.h
index a9ddcd08d0b3..00b06dcde845 100644
--- a/include/linux/damon.h
+++ b/include/linux/damon.h
@@ -154,6 +154,7 @@ enum damos_action {
  *
  * @DAMOS_QUOTA_USER_INPUT:	User-input value.
  * @DAMOS_QUOTA_SOME_MEM_PSI_US:	System level some memory PSI in us.
+ * @DAMOS_QUOTA_NODE_UTIL_BP:		Utilization ratio of a memory node.
  * @NR_DAMOS_QUOTA_GOAL_METRICS:	Number of DAMOS quota goal metrics.
  *
  * Metrics equal to larger than @NR_DAMOS_QUOTA_GOAL_METRICS are unsupported.
@@ -161,6 +162,7 @@ enum damos_action {
 enum damos_quota_goal_metric {
 	DAMOS_QUOTA_USER_INPUT,
 	DAMOS_QUOTA_SOME_MEM_PSI_US,
+	DAMOS_QUOTA_NODE_UTIL_BP,
 	NR_DAMOS_QUOTA_GOAL_METRICS,
 };
 
@@ -188,6 +190,7 @@ struct damos_quota_goal {
 	/* metric-dependent fields */
 	union {
 		u64 last_psi_total;
+		int nid;
 	};
 	struct list_head list;
 };
diff --git a/mm/damon/core.c b/mm/damon/core.c
index 2d608df16c86..a0b51d35c056 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -1946,6 +1946,17 @@ static inline u64 damos_get_some_mem_psi_total(void)
 
 #endif	/* CONFIG_PSI */
 
+/*
+ * damos_get_node_util_bp() - Return specific node memory utilization in bp
+ */
+static __kernel_ulong_t damos_get_node_util_bp(int nid)
+{
+	struct sysinfo i;
+
+	si_meminfo_node(&i, nid);
+	return (i.totalram - i.freeram) * 10000 / i.totalram;
+}
+
 static void damos_set_quota_goal_current_value(struct damos_quota_goal *goal)
 {
 	u64 now_psi_total;
@@ -1960,6 +1971,9 @@ static void damos_set_quota_goal_current_value(struct damos_quota_goal *goal)
 		goal->last_psi_total = now_psi_total;
 		pr_info("PSI current value %lu\n", goal->current_value);
 		break;
+	case DAMOS_QUOTA_NODE_UTIL_BP:
+		goal->current_value = damos_get_node_util_bp(goal->nid);
+		break;
 	default:
 		break;
 	}
diff --git a/mm/damon/sysfs-schemes.c b/mm/damon/sysfs-schemes.c
index e2088fe5d08b..6b2bc958a6a2 100644
--- a/mm/damon/sysfs-schemes.c
+++ b/mm/damon/sysfs-schemes.c
@@ -941,6 +941,7 @@ struct damos_sysfs_quota_goal {
 static const char * const damos_sysfs_quota_goal_metric_strs[] = {
 	"user_input",
 	"some_mem_psi_us",
+	"node_util_bp",
 };
 
 static struct damos_sysfs_quota_goal *damos_sysfs_quota_goal_alloc(void)
-- 
2.39.5

