From: SeongJae Park <sj@kernel.org>
Date: Wed, 4 Feb 2026 21:55:43 -0800
Subject: [PATCH] mm/damon/core: implement a function for setting all system
 rams as the target region

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 include/linux/damon.h |  5 +++++
 mm/damon/core.c       | 48 +++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 53 insertions(+)

diff --git a/include/linux/damon.h b/include/linux/damon.h
index a60b7b6575d96..74277255f809c 100644
--- a/include/linux/damon.h
+++ b/include/linux/damon.h
@@ -1130,6 +1130,11 @@ static inline void damon_report_page_fault(struct vm_fault *vmf, bool huge_pmd)
 }
 #endif
 
+int damon_set_region_system_rams_default(struct damon_target *t,
+				unsigned long *start, unsigned long *end,
+				unsigned long addr_unit,
+				unsigned long min_region_sz);
+
 int damon_set_region_biggest_system_ram_default(struct damon_target *t,
 				unsigned long *start, unsigned long *end,
 				unsigned long addr_unit,
diff --git a/mm/damon/core.c b/mm/damon/core.c
index f62f8003bd67e..3746bd7914ffc 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -3365,6 +3365,54 @@ static int kdamond_fn(void *data)
 	return 0;
 }
 
+struct damon_system_ram_range_walk_arg {
+	bool walked;
+	struct resource res;
+};
+
+static int damon_system_ram_walk_fn(struct resource *res, void *arg)
+{
+	struct damon_system_ram_range_walk_arg *a = arg;
+
+	if (!a->walked) {
+		a->walked = true;
+		a->res.start = res->start;
+	}
+	a->res.end = res->end;
+	return 0;
+}
+
+static bool damon_find_system_ram_range(unsigned long *start,
+		unsigned long *end, unsigned long addr_unit)
+{
+	struct damon_system_ram_range_walk_arg arg = {};
+
+	walk_system_ram_res(0, -1, &arg, damon_system_ram_walk_fn);
+	if (!arg.walked)
+		return false;
+	*start = arg.res.start / addr_unit;
+	*end = (arg.res.end + 1) / addr_unit;
+	return true;
+}
+
+int damon_set_region_system_rams_default(struct damon_target *t,
+			unsigned long *start, unsigned long *end,
+			unsigned long addr_unit, unsigned long min_region_sz)
+{
+	struct damon_addr_range addr_range;
+
+	if (*start > *end)
+		return -EINVAL;
+
+	if (!*start && !*end &&
+		!damon_find_system_ram_range(start, end, addr_unit))
+		return -EINVAL;
+
+	addr_range.start = *start;
+	addr_range.end = *end;
+	return damon_set_regions(t, &addr_range, addr_unit, min_region_sz);
+}
+
 static int walk_system_ram(struct resource *res, void *arg)
 {
 	struct resource *a = arg;
-- 
2.47.3

