From: SeongJae Park <sj@kernel.org>
Date: Mon, 16 Dec 2024 16:02:57 -0800
Subject: [PATCH] mm/damon: do per-scheme filtered stat update from core logic

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/core.c  | 6 ++++--
 mm/damon/paddr.c | 4 +---
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/mm/damon/core.c b/mm/damon/core.c
index 73ba60da63f8..b145d5d7030b 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -1383,13 +1383,15 @@ static bool damos_skip_charged_region(struct damon_target *t,
 }
 
 static void damos_update_stat(struct damos *s,
-		unsigned long sz_tried, unsigned long sz_applied)
+		unsigned long sz_tried, unsigned long sz_applied,
+		unsigned long sz_ops_filtered_out)
 {
 	s->stat.nr_tried++;
 	s->stat.sz_tried += sz_tried;
 	if (sz_applied)
 		s->stat.nr_applied++;
 	s->stat.sz_applied += sz_applied;
+	s->stat.sz_filtered_out += sz_ops_filtered_out;
 }
 
 static bool __damos_filter_out(struct damon_ctx *ctx, struct damon_target *t,
@@ -1618,7 +1620,7 @@ static void damos_apply_scheme(struct damon_ctx *c, struct damon_target *t,
 		r->age = 0;
 
 update_stat:
-	damos_update_stat(s, sz, sz_applied);
+	damos_update_stat(s, sz, sz_applied, sz_ops_filtered);
 }
 
 static void damon_do_apply_schemes(struct damon_ctx *c,
diff --git a/mm/damon/paddr.c b/mm/damon/paddr.c
index 361fe9fc5ea3..706869adc070 100644
--- a/mm/damon/paddr.c
+++ b/mm/damon/paddr.c
@@ -240,10 +240,8 @@ static bool damos_pa_filter_out(struct damos *scheme, struct folio *folio)
 	struct damos_filter *filter;
 
 	damos_for_each_filter(filter, scheme) {
-		if (__damos_pa_filter_out(filter, folio)) {
-			scheme->stat.sz_filtered_out += folio_size(folio);
+		if (__damos_pa_filter_out(filter, folio))
 			return true;
-		}
 	}
 	return false;
 }
-- 
2.39.5

