From: SeongJae Park <sj@kernel.org>
Date: Fri, 28 Nov 2025 15:24:29 -0800
Subject: [PATCH] mm/damon: implement damon_access_check_control commit

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 include/linux/damon.h |  4 +--
 mm/damon/core.c       | 79 ++++++++++++++++++++++++++++++++++++++++++-
 2 files changed, 80 insertions(+), 3 deletions(-)

diff --git a/include/linux/damon.h b/include/linux/damon.h
index 774f0fa262f4..2db6790b2b26 100644
--- a/include/linux/damon.h
+++ b/include/linux/damon.h
@@ -973,7 +973,7 @@ static inline unsigned long damon_sz_region(struct damon_region *r)
 	list_for_each_entry(f, &control->report_filters, list)
 
 #define damon_for_each_report_filter_safe(f, next, control) \
-	list_for_each_entry_safe(f, next, &control->report_filteers, list)
+	list_for_each_entry_safe(f, next, &control->report_filters, list)
 
 #define damon_for_each_scheme(s, ctx) \
 	list_for_each_entry(s, &(ctx)->schemes, list)
@@ -1051,7 +1051,7 @@ void damon_destroy_target(struct damon_target *t, struct damon_ctx *ctx);
 unsigned int damon_nr_regions(struct damon_target *t);
 
 struct damon_report_filter *damon_new_report_filter(
-		enum damon_report_filter_type *filter_type, bool matching,
+		enum damon_report_filter_type filter_type, bool matching,
 		bool allow);
 void damon_add_report_filter(struct damon_access_check_control *ctrl,
 		struct damon_report_filter *filter);
diff --git a/mm/damon/core.c b/mm/damon/core.c
index f10c425f26fb..38cc4b07be3a 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -534,7 +534,7 @@ unsigned int damon_nr_regions(struct damon_target *t)
 }
 
 struct damon_report_filter *damon_new_report_filter(
-		enum damon_report_filter_type *filter_type, bool matcing,
+		enum damon_report_filter_type filter_type, bool matching,
 		bool allow)
 {
 	struct damon_report_filter *filter;
@@ -573,6 +573,19 @@ void damon_destroy_report_filter(struct damon_report_filter *f,
 	damon_free_report_filter(f);
 }
 
+static struct damon_report_filter *damon_nth_report_filter(int n,
+		struct damon_access_check_control *ctrl)
+{
+	struct damon_report_filter *f;
+	int i = 0;
+
+	damon_for_each_report_filter(f, ctrl) {
+		if (i++ == n)
+			return f;
+	}
+	return NULL;
+}
+
 struct damon_ctx *damon_new_ctx(void)
 {
 	struct damon_ctx *ctx;
@@ -1288,6 +1301,66 @@ static int damon_commit_targets(
 	return 0;
 }
 
+static void damon_commit_report_filter_arg(struct damon_report_filter *dst,
+		struct damon_report_filter *src)
+{
+	switch (dst->type) {
+	case DAMON_FILTER_TYPE_CPUS:
+		dst->cpus = src->cpus;
+		break;
+	case DAMON_FILTER_TYPE_WRITE:
+		dst->write = src->write;
+		break;
+	default:
+		break;
+	}
+}
+
+static void damon_commit_report_filter(struct damon_report_filter *dst,
+		struct damon_report_filter *src)
+{
+	dst->matching = src->matching;
+	dst->allow = src->allow;
+	damon_commit_report_filter_arg(dst, src);
+}
+
+static int damon_commit_report_filters(struct damon_access_check_control *dst,
+		struct damon_access_check_control *src)
+{
+	struct damon_report_filter *dst_filter, *next, *src_filter, *new_filter;
+	int i = 0, j = 0;
+
+	damon_for_each_report_filter_safe(dst_filter, next, dst) {
+		src_filter = damon_nth_report_filter(i++, src);
+		if (src_filter)
+			damon_commit_report_filter(dst_filter, src_filter);
+		else
+			damon_destroy_report_filter(dst_filter, dst);
+	}
+
+	damon_for_each_report_filter_safe(src_filter, next, src) {
+		if (j++ < i)
+			continue;
+
+		new_filter = damon_new_report_filter(
+				src_filter->type, src_filter->matching,
+				src_filter->allow);
+		if (!new_filter)
+			return -ENOMEM;
+		damon_commit_report_filter_arg(new_filter, src_filter);
+		damon_add_report_filter(dst, new_filter);
+	}
+	return 0;
+}
+
+static int damon_commit_access_check_control(
+		struct damon_access_check_control *dst,
+		struct damon_access_check_control *src)
+{
+	dst->primitives_enablement = src->primitives_enablement;
+	return damon_commit_report_filters(dst, src);
+}
+
 /**
  * damon_commit_ctx() - Commit parameters of a DAMON context to another.
  * @dst:	The commit destination DAMON context.
@@ -1325,6 +1398,10 @@ int damon_commit_ctx(struct damon_ctx *dst, struct damon_ctx *src)
 	}
 	dst->ops = src->ops;
 	dst->ops_attrs = src->ops_attrs;
+	err = damon_commit_access_check_control(&dst->access_check_control,
+			&src->access_check_control);
+	if (err)
+		return err;
 	dst->addr_unit = src->addr_unit;
 	dst->min_sz_region = src->min_sz_region;
 
-- 
2.47.3

