From: SeongJae Park <sj@kernel.org>
Date: Sat, 14 Jun 2025 14:05:23 -0700
Subject: [PATCH] mm/damon: introduce active:inactive memory ratio damos quota
 goal metric

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 include/linux/damon.h    |  2 ++
 mm/damon/core.c          | 17 +++++++++++++++++
 mm/damon/sysfs-schemes.c |  1 +
 3 files changed, 20 insertions(+)

diff --git a/include/linux/damon.h b/include/linux/damon.h
index 1c0b695b2295..bd8cb8a31e5c 100644
--- a/include/linux/damon.h
+++ b/include/linux/damon.h
@@ -175,6 +175,7 @@ enum damos_action {
  * @DAMOS_QUOTA_SOME_MEM_PSI_US:	System level some memory PSI in us.
  * @DAMOS_QUOTA_NODE_MEM_USED_BP:	MemUsed ratio of a node.
  * @DAMOS_QUOTA_NODE_MEM_FREE_BP:	MemFree ratio of a node.
+ * @DAMOS_QUOTA_ACTIVE_MEM_BP:		Active to inactive memory ratio.
  * @NR_DAMOS_QUOTA_GOAL_METRICS:	Number of DAMOS quota goal metrics.
  *
  * Metrics equal to larger than @NR_DAMOS_QUOTA_GOAL_METRICS are unsupported.
@@ -184,6 +185,7 @@ enum damos_quota_goal_metric {
 	DAMOS_QUOTA_SOME_MEM_PSI_US,
 	DAMOS_QUOTA_NODE_MEM_USED_BP,
 	DAMOS_QUOTA_NODE_MEM_FREE_BP,
+	DAMOS_QUOTA_ACTIVE_MEM_BP,
 	NR_DAMOS_QUOTA_GOAL_METRICS,
 };
 
diff --git a/mm/damon/core.c b/mm/damon/core.c
index 7353a01e40f2..d675dd932a23 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -2029,6 +2029,20 @@ static __kernel_ulong_t damos_get_node_mem_bp(
 }
 #endif
 
+/*
+ * Returns LRU-active memory to LRU-inactive memory size ratio.
+ */
+static unsigned int damos_get_active_inactive_mem_bp(void)
+{
+	unsigned long active, inactive;
+
+	/* This should align with /proc/meminfo output */
+	active = global_node_page_state(NR_LRU_BASE + LRU_ACTIVE_ANON) +
+		global_node_page_state(NR_LRU_BASE + LRU_ACTIVE_FILE);
+	inactive = global_node_page_state(NR_LRU_BASE + LRU_INACTIVE_ANON) +
+		global_node_page_state(NR_LRU_BASE + LRU_INACTIVE_FILE);
+	return active * 10000 / inactive;
+}
 
 static void damos_set_quota_goal_current_value(struct damos_quota_goal *goal)
 {
@@ -2048,6 +2062,9 @@ static void damos_set_quota_goal_current_value(struct damos_quota_goal *goal)
 	case DAMOS_QUOTA_NODE_MEM_FREE_BP:
 		goal->current_value = damos_get_node_mem_bp(goal);
 		break;
+	case DAMOS_QUOTA_ACTIVE_MEM_BP:
+		goal->current_value = damos_get_active_inactive_mem_bp();
+		break;
 	default:
 		break;
 	}
diff --git a/mm/damon/sysfs-schemes.c b/mm/damon/sysfs-schemes.c
index 46aa64b59918..575905fe66f9 100644
--- a/mm/damon/sysfs-schemes.c
+++ b/mm/damon/sysfs-schemes.c
@@ -946,6 +946,7 @@ static const char * const damos_sysfs_quota_goal_metric_strs[] = {
 	"some_mem_psi_us",
 	"node_mem_used_bp",
 	"node_mem_free_bp",
+	"active_mem_bp",
 };
 
 static struct damos_sysfs_quota_goal *damos_sysfs_quota_goal_alloc(void)
-- 
2.39.5

