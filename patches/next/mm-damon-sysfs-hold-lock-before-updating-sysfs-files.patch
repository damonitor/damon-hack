From: SeongJae Park <sj@kernel.org>
Date: Sun, 6 Jul 2025 14:39:35 -0700
Subject: [PATCH] mm/damon/sysfs: hold lock before updating sysfs files

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/sysfs.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/mm/damon/sysfs.c b/mm/damon/sysfs.c
index a263e9aff36c..6d2b0dab50cb 100644
--- a/mm/damon/sysfs.c
+++ b/mm/damon/sysfs.c
@@ -1521,9 +1521,12 @@ static int damon_sysfs_repeat_call_fn(void *data)
 	next_update_jiffies = jiffies +
 		msecs_to_jiffies(sysfs_kdamond->refresh_ms);
 
+	if (!mutex_trylock(&damon_sysfs_lock))
+		return 0;
 	damon_sysfs_upd_tuned_intervals(sysfs_kdamond);
 	damon_sysfs_upd_schemes_stats(sysfs_kdamond);
 	damon_sysfs_upd_schemes_effective_quotas(sysfs_kdamond);
+	mutex_unlock(&damon_sysfs_lock);
 	return 0;
 }
 
-- 
2.39.5

