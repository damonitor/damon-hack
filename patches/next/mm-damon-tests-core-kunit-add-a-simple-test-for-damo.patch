From: SeongJae Park <sj@kernel.org>
Date: Sat, 11 Oct 2025 12:45:00 -0700
Subject: [PATCH] mm/damon/tests/core-kunit: add a simple test for
 damon_commit_targets()

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/tests/core-kunit.h | 51 +++++++++++++++++++++++++++++++++++++
 1 file changed, 51 insertions(+)

diff --git a/mm/damon/tests/core-kunit.h b/mm/damon/tests/core-kunit.h
index 5c6592968317..13f91a0d70d4 100644
--- a/mm/damon/tests/core-kunit.h
+++ b/mm/damon/tests/core-kunit.h
@@ -932,6 +932,56 @@ static void damon_test_commit_ctx(struct kunit *test)
 	damon_destroy_ctx(dst);
 }
 
+static int damon_test_commit_targets_set_n_targets(
+		struct damon_ctx *ctx, int nr_targets)
+{
+	struct damon_target *target;
+	int i;
+
+	for (i = 0; i < nr_targets; i++) {
+		target = damon_new_target();
+		if (!target)
+			return -ENOMEM;
+		damon_add_target(ctx, target);
+	}
+	return 0;
+}
+
+static void damon_test_commit_targets(struct kunit *test)
+{
+	struct damon_ctx *dst, *src;
+	struct damon_target *t;
+	int err = 0, i;
+
+	dst = damon_new_ctx();
+	if (!dst)
+		kunit_skip(test, "dst alloc fail");
+	src = damon_new_ctx();
+	if (!src) {
+		damon_destroy_ctx(dst);
+		kunit_skip(test, "src alloc fail");
+	}
+	if (damon_test_commit_targets_set_n_targets(src, 5)) {
+		damon_destroy_ctx(src);
+		damon_destroy_ctx(dst);
+		kunit_skip(test, "src targets set fail");
+	}
+	if (damon_test_commit_targets_set_n_targets(dst, 5)) {
+		damon_destroy_ctx(src);
+		damon_destroy_ctx(dst);
+		kunit_skip(test, "dst targets set fail");
+	}
+	err = damon_commit_targets(dst, src);
+	KUNIT_EXPECT_EQ(test, err, 0);
+	i = 0;
+	damon_for_each_target(t, dst)
+		i++;
+	KUNIT_EXPECT_EQ(test, i, 5);
+
+	damon_destroy_ctx(src);
+	damon_destroy_ctx(dst);
+}
+
 static struct kunit_case damon_test_cases[] = {
 	KUNIT_CASE(damon_test_target),
 	KUNIT_CASE(damon_test_regions),
@@ -954,6 +1004,7 @@ static struct kunit_case damon_test_cases[] = {
 	KUNIT_CASE(damon_test_feed_loop_next_input),
 	KUNIT_CASE(damon_test_set_filters_default_reject),
 	KUNIT_CASE(damon_test_commit_ctx),
+	KUNIT_CASE(damon_test_commit_targets),
 	{},
 };
 
-- 
2.47.3

