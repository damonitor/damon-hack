From: SeongJae Park <sj@kernel.org>
Date: Fri, 17 Oct 2025 12:02:06 -0700
Subject: [PATCH] mm/damon/tests/core-kunit: cleanup damos_commit_quota_goals()
 test

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/tests/core-kunit.h | 97 ++++++++++++++++++++++++++-----------
 1 file changed, 68 insertions(+), 29 deletions(-)

diff --git a/mm/damon/tests/core-kunit.h b/mm/damon/tests/core-kunit.h
index dbab4697f752..e2d7a1505508 100644
--- a/mm/damon/tests/core-kunit.h
+++ b/mm/damon/tests/core-kunit.h
@@ -520,45 +520,84 @@ static void damos_test_commit_quota_goal(struct kunit *test)
 			});
 }
 
-static void damos_test_commit_quota_goals(struct kunit *test)
+static void damos_test_commit_quota_goals_for(struct kunit *test,
+		struct damos_quota_goal *dst_goals, int nr_dst_goals,
+		struct damos_quota_goal *src_goals, int nr_src_goals)
 {
-	struct damos_quota dst = {
-		.reset_interval = 1,
-		.ms = 2,
-		.sz = 3,
-		.weight_sz = 4,
-		.weight_nr_accesses = 5,
-		.weight_age = 6,
-	};
-	struct damos_quota src = dst;
-	struct damos_quota_goal *goal, *dst_goal, *next;
-	int nr_dst_goals = 0;
+	struct damos_quota dst, src;
+	struct damos_quota_goal *goal, *next;
+	bool skip = true;
+	int i;
 
 	INIT_LIST_HEAD(&dst.goals);
 	INIT_LIST_HEAD(&src.goals);
 
-	goal = damos_new_quota_goal(DAMOS_QUOTA_USER_INPUT, 1000);
-	if (!goal)
-		kunit_skip(test, "gaol alloc fail\n");
-	goal->current_value = 500;
-	damos_add_quota_goal(&src, goal);
+	for (i = 0; i < nr_dst_goals; i++) {
+		/*
+		 * When nr_src_goals is smaller than dst_goals,
+		 * damos_commit_quota_goals() will kfree() the dst goals.
+		 * Make it kfree()-able.
+		 */
+		goal = damos_new_quota_goal(dst_goals[i].metric,
+				dst_goals[i].target_value);
+		if (!goal)
+			goto out;
+		damos_add_quota_goal(&dst, goal);
+	}
+	skip = false;
+	for (i = 0; i < nr_src_goals; i++)
+		damos_add_quota_goal(&src, &src_goals[i]);
+
 	damos_commit_quota_goals(&dst, &src);
 
-	damos_for_each_quota_goal(dst_goal, (&dst)) {
-		nr_dst_goals++;
-		KUNIT_EXPECT_EQ(test, dst_goal->target_value,
-				goal->target_value);
-		KUNIT_EXPECT_EQ(test, dst_goal->metric, goal->metric);
-		KUNIT_EXPECT_EQ(test, dst_goal->current_value,
-				goal->current_value);
+	i = 0;
+	damos_for_each_quota_goal(goal, (&dst)) {
+		KUNIT_EXPECT_EQ(test, goal->metric, src_goals[i].metric);
+		KUNIT_EXPECT_EQ(test, goal->target_value,
+				src_goals[i++].target_value);
 	}
-	KUNIT_EXPECT_EQ(test, nr_dst_goals, 1);
+	KUNIT_EXPECT_EQ(test, i, nr_src_goals);
 
-	/* TODO: test in place commit and removal commit */
+out:
+	damos_for_each_quota_goal_safe(goal, next, (&dst))
+		damos_destroy_quota_goal(goal);
+	if (skip)
+		kunit_skip(test, "goal alloc fail");
+}
 
-	damos_destroy_quota_goal(goal);
-	damos_for_each_quota_goal_safe(dst_goal, next, (&dst))
-		damos_destroy_quota_goal(dst_goal);
+static void damos_test_commit_quota_goals(struct kunit *test)
+{
+	damos_test_commit_quota_goals_for(test,
+			(struct damos_quota_goal[]){}, 0,
+			(struct damos_quota_goal[]){
+				{
+				.metric = DAMOS_QUOTA_USER_INPUT,
+				.target_value = 123,
+				},
+			}, 1);
+	damos_test_commit_quota_goals_for(test,
+			(struct damos_quota_goal[]){
+				{
+				.metric = DAMOS_QUOTA_USER_INPUT,
+				.target_value = 234,
+				},
+
+			}, 1,
+			(struct damos_quota_goal[]){
+				{
+				.metric = DAMOS_QUOTA_USER_INPUT,
+				.target_value = 345,
+				},
+			}, 1);
+	damos_test_commit_quota_goals_for(test,
+			(struct damos_quota_goal[]){
+				{
+				.metric = DAMOS_QUOTA_USER_INPUT,
+				.target_value = 456,
+				},
+
+			}, 1,
+			(struct damos_quota_goal[]){}, 0);
 }
 
 static void damos_test_commit_quota(struct kunit *test)
-- 
2.47.3

