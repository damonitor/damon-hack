From: SeongJae Park <sj@kernel.org>
Date: Wed, 5 Nov 2025 22:16:31 -0800
Subject: [PATCH] mm/damon/tests/core-kunit: cleanup
 test_commit_target_regions()

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/tests/core-kunit.h | 51 +++++++++++++++++++------------------
 1 file changed, 26 insertions(+), 25 deletions(-)

diff --git a/mm/damon/tests/core-kunit.h b/mm/damon/tests/core-kunit.h
index db9c54628ba4..8f1259fdb77b 100644
--- a/mm/damon/tests/core-kunit.h
+++ b/mm/damon/tests/core-kunit.h
@@ -964,6 +964,28 @@ static void damos_test_commit(struct kunit *test)
 			});
 }
 
+static struct damon_target *damon_test_help_setup_target(
+		unsigned long region_start_end[][2], int nr_regions)
+{
+	struct damon_target *t;
+	struct damon_region *r;
+	int i;
+
+	t = damon_new_target();
+	if (!t)
+		return NULL;
+	for (i = 0; i < nr_regions; i++) {
+		r = damon_new_region(region_start_end[i][0],
+				region_start_end[i][1]);
+		if (!r) {
+			damon_free_target(t);
+			return NULL;
+		}
+		damon_add_region(r, t);
+	}
+	return t;
+}
+
 static void damon_test_commit_target_regions_for(struct kunit *test,
 		unsigned long dst_start_end[][2], int nr_dst_regions,
 		unsigned long src_start_end[][2], int nr_src_regions,
@@ -973,35 +995,15 @@ static void damon_test_commit_target_regions_for(struct kunit *test,
 	struct damon_region *r;
 	int i;
 
-	dst_target = damon_new_target();
+	dst_target = damon_test_help_setup_target(dst_start_end, nr_dst_regions);
 	if (!dst_target)
-		kunit_skip(test, "dst target alloc fail");
-	src_target = damon_new_target();
+		kunit_skip(test, "dst target setup fail");
+	src_target = damon_test_help_setup_target(src_start_end, nr_src_regions);
 	if (!src_target) {
 		damon_free_target(dst_target);
-		kunit_skip(test, "src target alloc fail");
-	}
-	for (i = 0; i < nr_dst_regions; i++) {
-		r = damon_new_region(dst_start_end[i][0], dst_start_end[i][1]);
-		if (!r) {
-			damon_free_target(dst_target);
-			damon_free_target(src_target);
-			kunit_skip(test, "region alloc fail");
-		}
-		damon_add_region(r, dst_target);
-	}
-	for (i = 0; i < nr_src_regions; i++) {
-		r = damon_new_region(src_start_end[i][0], src_start_end[i][1]);
-		if (!r) {
-			damon_free_target(dst_target);
-			damon_free_target(src_target);
-			kunit_skip(test, "region alloc fail");
-		}
-		damon_add_region(r, src_target);
+		kunit_skip(test, "src target setup fail");
 	}
-
 	damon_commit_target_regions(dst_target, src_target, 1);
-
 	i = 0;
 	damon_for_each_region(r, dst_target) {
 		KUNIT_EXPECT_EQ(test, r->ar.start, expect_start_end[i][0]);
@@ -1009,7 +1011,6 @@ static void damon_test_commit_target_regions_for(struct kunit *test,
 		i++;
 	}
 	KUNIT_EXPECT_EQ(test, i, nr_expect_regions);
-
 	damon_free_target(dst_target);
 	damon_free_target(src_target);
 }
-- 
2.47.3

