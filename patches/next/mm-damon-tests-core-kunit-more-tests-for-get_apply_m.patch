From: SeongJae Park <sj@kernel.org>
Date: Sat, 14 Feb 2026 12:30:46 -0800
Subject: [PATCH] mm/damon/tests/core-kunit: more tests for
 get_apply_max_region_sz

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/tests/core-kunit.h | 34 ++++++++++++++++++++++++++++------
 1 file changed, 28 insertions(+), 6 deletions(-)

diff --git a/mm/damon/tests/core-kunit.h b/mm/damon/tests/core-kunit.h
index 8ebc1e9824bf7..507f1bffec630 100644
--- a/mm/damon/tests/core-kunit.h
+++ b/mm/damon/tests/core-kunit.h
@@ -1260,7 +1260,11 @@ static void damon_test_set_filters_default_reject(struct kunit *test)
 	damos_free_filter(target_filter);
 }
 
-static void damon_test_get_apply_max_region_sz(struct kunit *test)
+static void damon_test_get_apply_max_region_sz_for(struct kunit *test,
+		unsigned long sz_regions, unsigned long min_region_sz,
+		unsigned long min_nr_regions,
+		unsigned long max_region_sz_expect,
+		unsigned long nr_regions_expect)
 {
 	struct damon_ctx *ctx;
 	struct damon_target *t;
@@ -1276,17 +1280,35 @@ static void damon_test_get_apply_max_region_sz(struct kunit *test)
 		kunit_skip(test, "target alloc fail\n");
 	}
 	damon_add_target(ctx, t);
-	r = damon_new_region(0, 10);
+	r = damon_new_region(0, sz_regions);
 	if (!r) {
 		damon_destroy_ctx(ctx);
 		kunit_skip(test, "region alloc fail\n");
 	}
 	damon_add_region(r, t);
-	ctx->min_region_sz = 1;
-	ctx->attrs.min_nr_regions = 10;
+
+	ctx->min_region_sz = min_region_sz;
+	ctx->attrs.min_nr_regions = min_nr_regions;
 	max_region_size = kdamond_get_apply_max_region_sz(ctx);
-	KUNIT_EXPECT_EQ(test, max_region_size, 1);
-	KUNIT_EXPECT_EQ(test, damon_nr_regions(t), 10);
+
+	KUNIT_EXPECT_EQ(test, max_region_size, max_region_sz_expect);
+	KUNIT_EXPECT_EQ(test, damon_nr_regions(t), nr_regions_expect);
+
+	damon_destroy_ctx(ctx);
+}
+
+static void damon_test_get_apply_max_region_sz(struct kunit *test)
+{
+	/* common, expected setup */
+	damon_test_get_apply_max_region_sz_for(test, 10, 1, 10, 1, 10);
+	/* no zero size limit */
+	damon_test_get_apply_max_region_sz_for(test, 10, 1, 15, 1, 10);
+	/* max size should be aligned by min_region_sz */
+	damon_test_get_apply_max_region_sz_for(test, 10, 2, 2, 6, 2);
+	/*
+	 * when min_nr_regions and min_region_sz conflicts, min_region_sz wins.
+	 */
+	damon_test_get_apply_max_region_sz_for(test, 10, 2, 10, 2, 5);
 }
 
 static void damon_test_is_last_region(struct kunit *test)
-- 
2.47.3

