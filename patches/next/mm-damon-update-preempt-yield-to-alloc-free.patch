From 5a14f9ba2ae2b6078f8fa8fc2941252ebf0df086 Mon Sep 17 00:00:00 2001
From: SeongJae Park <sj@kernel.org>
Date: Thu, 9 May 2024 14:21:46 -0700
Subject: [PATCH] mm/damon: update preempt/yield to alloc/free

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 include/linux/damon.h    | 11 +++++++----
 mm/damon/acma.c          |  4 ++--
 mm/damon/sysfs-schemes.c |  4 ++--
 3 files changed, 11 insertions(+), 8 deletions(-)

diff --git a/include/linux/damon.h b/include/linux/damon.h
index 23c83fab5fcd..c2632aba9d23 100644
--- a/include/linux/damon.h
+++ b/include/linux/damon.h
@@ -106,8 +106,9 @@ struct damon_target {
  * @DAMOS_LRU_PRIO:	Prioritize the region on its LRU lists.
  * @DAMOS_LRU_DEPRIO:	Deprioritize the region on its LRU lists.
 #ifdef CONFIG_ACMA
- * @DAMOS_PREEMPT:	Pass ownership to page reporting subscribers.
- * @DAMOS_YIELD:	Return ownership to the system.
+ * @DAMOS_ALLOC:	Allocate pages in the region,
+ *			&struct damos->alloc_order pages at once.
+ * @DAMOS_FREE:		Return DAMOS_ALLOC-ed pages back to the system.
 #endif
  * @DAMOS_STAT:		Do nothing but count the stat.
  * @NR_DAMOS_ACTIONS:	Total number of DAMOS actions
@@ -127,8 +128,8 @@ enum damos_action {
 	DAMOS_LRU_PRIO,
 	DAMOS_LRU_DEPRIO,
 #ifdef CONFIG_ACMA
-	DAMOS_PREEMPT,
-	DAMOS_YIELD,
+	DAMOS_ALLOC,
+	DAMOS_FREE,
 #endif
 	DAMOS_STAT,		/* Do nothing but only record the stat */
 	NR_DAMOS_ACTIONS,
@@ -408,6 +409,8 @@ struct damos_access_pattern {
 struct damos {
 	struct damos_access_pattern pattern;
 	enum damos_action action;
+	unsigned int alloc_order;
+	int (*alloc_callback)(unsigned long start_addr);
 	unsigned long apply_interval_us;
 /* private: internal use only */
 	/*
diff --git a/mm/damon/acma.c b/mm/damon/acma.c
index b953a8e456d3..bdc3694cfc26 100644
--- a/mm/damon/acma.c
+++ b/mm/damon/acma.c
@@ -347,10 +347,10 @@ static int damon_acma_set_scale_up_region_filter(struct damos *scheme)
  * Called back from DAMOS for every damos->alloc_order contig pages that
  * just successfully DAMOS_ALLOC-ed.
  */
-static int damon_acma_alloc_callback(unsigned long pfn)
+static int damon_acma_alloc_callback(unsigned long start_addr)
 {
 	/* For non-zero return value, DAMOS free the pages. */
-	return page_report(pfn, 1 << scale_pg_order);
+	return page_report(PHYS_PFN(addr), 1 << scale_pg_order);
 }
 
 static int damon_acma_apply_parameters(void)
diff --git a/mm/damon/sysfs-schemes.c b/mm/damon/sysfs-schemes.c
index a38a60344d16..c471e64fe4ab 100644
--- a/mm/damon/sysfs-schemes.c
+++ b/mm/damon/sysfs-schemes.c
@@ -1457,8 +1457,8 @@ static const char * const damon_sysfs_damos_action_strs[] = {
 	"lru_prio",
 	"lru_deprio",
 #ifdef CONFIG_ACMA
-	"damos_preempt",
-	"damos_yield",
+	"damos_alloc",
+	"damos_free",
 #endif
 	"stat",
 };
-- 
2.39.2

