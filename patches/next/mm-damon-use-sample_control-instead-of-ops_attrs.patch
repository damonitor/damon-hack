From: SeongJae Park <sj@kernel.org>
Date: Sun, 30 Nov 2025 09:19:10 -0800
Subject: [PATCH] mm/damon: use sample_control instead of ops_attrs

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/damon/core.c  | 6 +++---
 mm/damon/paddr.c | 4 ++--
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/mm/damon/core.c b/mm/damon/core.c
index 03552c9dca80..344d2408439c 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -3031,8 +3031,7 @@ static void kdamond_apply_access_report(struct damon_access_report *report,
 {
 	struct damon_region *r;
 
-	if (ctx->ops.eligible_report && !ctx->ops.eligible_report(report, t,
-				&ctx->ops_attrs))
+	if (damon_sample_filter_out(report, &ctx->sample_control))
 		return;
 
 	/* todo: make search faster, e.g., binary search? */
@@ -3135,7 +3134,8 @@ static int kdamond_fn(void *data)
 		kdamond_usleep(sample_interval);
 		ctx->passed_sample_intervals++;
 
-		if (ctx->ops_attrs.use_reports)
+		/* todo: make these non-exclusive */
+		if (ctx->sample_control.primitives_enabled.page_faults)
 			max_nr_accesses = kdamond_check_reported_accesses(ctx);
 		else if (ctx->ops.check_accesses)
 			max_nr_accesses = ctx->ops.check_accesses(ctx);
diff --git a/mm/damon/paddr.c b/mm/damon/paddr.c
index 4361224b729d..957ef65b262f 100644
--- a/mm/damon/paddr.c
+++ b/mm/damon/paddr.c
@@ -125,9 +125,9 @@ static void damon_pa_prepare_access_checks_faults(struct damon_ctx *ctx)
 
 static void damon_pa_prepare_access_checks(struct damon_ctx *ctx)
 {
-	if (!ctx->ops_attrs.use_reports)
+	if (ctx->sample_control.primitives_enabled.page_table)
 		damon_pa_prepare_access_checks_abit(ctx);
-	else
+	if (ctx->sample_control.primitives_enabled.page_faults)
 		damon_pa_prepare_access_checks_faults(ctx);
 }
 
-- 
2.47.3

