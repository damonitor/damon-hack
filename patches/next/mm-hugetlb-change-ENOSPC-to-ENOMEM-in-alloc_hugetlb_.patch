From: Dafna Hirschfeld <dafna.hirschfeld@intel.com>
Date: Sun, 1 Dec 2024 03:03:41 +0200
Subject: [PATCH] mm/hugetlb: change ENOSPC to ENOMEM in alloc_hugetlb_folio

The error ENOSPC is translated in vmf_error to VM_FAULT_SIGBUS which is
further translated in EFAULT in i.e.  pin/get_user_pages.  But when
running out of pages/hugepages we expect to see ENOMEM and not EFAULT.

Link: https://lkml.kernel.org/r/20241201010341.1382431-1-dafna.hirschfeld@intel.com
Fixes: 8f34af6f93ae ("mm, hugetlb: move the error handle logic out of normal code path")
Signed-off-by: Dafna Hirschfeld <dafna.hirschfeld@intel.com>
Cc: Muchun Song <muchun.song@linux.dev>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
---
 mm/hugetlb.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/mm/hugetlb.c b/mm/hugetlb.c
index ea2ed8e301ef..32cab9ab4783 100644
--- a/mm/hugetlb.c
+++ b/mm/hugetlb.c
@@ -3113,7 +3113,7 @@ struct folio *alloc_hugetlb_folio(struct vm_area_struct *vma,
 	if (!memcg_charge_ret)
 		mem_cgroup_cancel_charge(memcg, nr_pages);
 	mem_cgroup_put(memcg);
-	return ERR_PTR(-ENOSPC);
+	return ERR_PTR(-ENOMEM);
 }
 
 int alloc_bootmem_huge_page(struct hstate *h, int nid)
-- 
2.39.5

