From: SeongJae Park <sj@kernel.org>
Date: Sat, 26 Jul 2025 13:33:55 -0700
Subject: [PATCH] mm/memory: do_damon_page() only if numa balancing is not
 running

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/memory.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/mm/memory.c b/mm/memory.c
index adeb0d7f6a6b..e80d70921c33 100644
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -6052,7 +6052,8 @@ static vm_fault_t handle_pte_fault(struct vm_fault *vmf)
 		return do_swap_page(vmf);
 
 	if (pte_protnone(vmf->orig_pte) && vma_is_accessible(vmf->vma)) {
-		do_damon_page(vmf, false);
+		if (sysctl_numa_balancing_mode == NUMA_BALANCING_DISABLED)
+			return do_damon_page(vmf, false);
 		return do_numa_page(vmf);
 	}
 
@@ -6177,7 +6178,9 @@ static vm_fault_t __handle_mm_fault(struct vm_area_struct *vma,
 		}
 		if (pmd_trans_huge(vmf.orig_pmd)) {
 			if (pmd_protnone(vmf.orig_pmd) && vma_is_accessible(vma)) {
-				do_damon_page(&vmf, true);
+				if (sysctl_numa_balancing_mode ==
+						NUMA_BALANCING_DISABLED)
+					return do_damon_page(&vmf, true);
 				return do_huge_pmd_numa_page(&vmf);
 			}
 
-- 
2.39.5

