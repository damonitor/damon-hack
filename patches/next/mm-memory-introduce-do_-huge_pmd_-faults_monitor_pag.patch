From: SeongJae Park <sj@kernel.org>
Date: Mon, 17 Nov 2025 22:16:59 -0800
Subject: [PATCH] mm/memory: introduce do_{,huge_pmd_}faults_monitor_page()

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 mm/memory.c | 32 +++++++++++++++++++++-----------
 1 file changed, 21 insertions(+), 11 deletions(-)

diff --git a/mm/memory.c b/mm/memory.c
index 01b54d431bba..50401ac5337f 100644
--- a/mm/memory.c
+++ b/mm/memory.c
@@ -6075,6 +6075,15 @@ static vm_fault_t do_numa_page(struct vm_fault *vmf)
 	return 0;
 }
 
+static vm_fault_t do_damon_page(struct vm_fault *vmf, bool huge_pmd);
+
+static vm_fault_t do_faults_monitor_page(struct vm_fault *vmf)
+{
+	if (sysctl_numa_balancing_mode == NUMA_BALANCING_DISABLED)
+		return do_damon_page(vmf, false);
+	return do_numa_page(vmf);
+}
+
 static inline vm_fault_t create_huge_pmd(struct vm_fault *vmf)
 {
 	struct vm_area_struct *vma = vmf->vma;
@@ -6307,11 +6316,8 @@ static vm_fault_t handle_pte_fault(struct vm_fault *vmf)
 	if (!pte_present(vmf->orig_pte))
 		return do_swap_page(vmf);
 
-	if (pte_protnone(vmf->orig_pte) && vma_is_accessible(vmf->vma)) {
-		if (sysctl_numa_balancing_mode == NUMA_BALANCING_DISABLED)
-			return do_damon_page(vmf, false);
-		return do_numa_page(vmf);
-	}
+	if (pte_protnone(vmf->orig_pte) && vma_is_accessible(vmf->vma))
+		return do_faults_monitor_page(vmf);
 
 	spin_lock(vmf->ptl);
 	entry = vmf->orig_pte;
@@ -6337,6 +6343,14 @@ static vm_fault_t handle_pte_fault(struct vm_fault *vmf)
 	return 0;
 }
 
+static vm_fault_t do_huge_pmd_faults_monitor_page(struct vm_fault *vmf)
+{
+	if (sysctl_numa_balancing_mode ==
+			NUMA_BALANCING_DISABLED)
+		return do_damon_page(vmf, true);
+	return do_huge_pmd_numa_page(vmf);
+}
+
 /*
  * On entry, we hold either the VMA lock or the mmap_lock
  * (FAULT_FLAG_VMA_LOCK tells you which).  If VM_FAULT_RETRY is set in
@@ -6425,12 +6439,8 @@ static vm_fault_t __handle_mm_fault(struct vm_area_struct *vma,
 		return 0;
 	}
 	if (pmd_trans_huge(vmf.orig_pmd)) {
-		if (pmd_protnone(vmf.orig_pmd) && vma_is_accessible(vma)) {
-			if (sysctl_numa_balancing_mode ==
-					NUMA_BALANCING_DISABLED)
-				return do_damon_page(&vmf, true);
-			return do_huge_pmd_numa_page(&vmf);
-		}
+		if (pmd_protnone(vmf.orig_pmd) && vma_is_accessible(vma))
+			return do_huge_pmd_faults_monitor_page(&vmf);
 
 		if ((flags & (FAULT_FLAG_WRITE|FAULT_FLAG_UNSHARE)) &&
 		    !pmd_write(vmf.orig_pmd)) {
-- 
2.47.3

