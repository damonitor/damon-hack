From: SeongJae Park <sj@kernel.org>
Date: Tue, 2 Dec 2025 21:22:10 -0800
Subject: [PATCH] revert "mm/damon: support threads type access sample filter"

Signed-off-by: SeongJae Park <sj@kernel.org>
---
 include/linux/damon.h | 19 ++++---------------
 mm/damon/core.c       | 28 ----------------------------
 2 files changed, 4 insertions(+), 43 deletions(-)

diff --git a/include/linux/damon.h b/include/linux/damon.h
index e3408280ea72..80332bb2b73c 100644
--- a/include/linux/damon.h
+++ b/include/linux/damon.h
@@ -787,13 +787,11 @@ struct damon_primitives_enabled {
  * enum damon_sample_filter_type - Type of &struct damon_sample_filter.
  *
  * @DAMON_FILTER_TYPE_CPUMASK:	Filter by access-generated CPUs.
- * @DAMON_FILTER_TYPE_THREADS:	Filter by access-generated threads.
  *
  * Read &struct damon_sample_control for more details.
  */
 enum damon_sample_filter_type {
 	DAMON_FILTER_TYPE_CPUMASK,
-	DAMON_FILTER_TYPE_THREADS,
 };
 
 /**
@@ -803,9 +801,6 @@ enum damon_sample_filter_type {
  * @matching:	Whether it is for condition-matching reports.
  * @allow:	Whether to include or excludie the @matching reports.
  * @cpumask:	Access-generated CPUs if @type is DAMON_FILTER_TYPE_CPUMASK.
- * @tid_arr:	Array of access-generated thread ids, if @type is
- *		DAMON_FILTER_TYPE_THREADS.
- * @nr_tids:	Size of @tid_arr, if @type is DAMON_FILTER_TYPE_THREADS.
  * @list:	List head for siblings.
  *
  * Read &struct damon_sample_control for more details.
@@ -814,13 +809,7 @@ struct damon_sample_filter {
 	enum damon_sample_filter_type type;
 	bool matching;
 	bool allow;
-	union {
-		cpumask_t cpumask;
-		struct {
-			pid_t *tid_arr;
-			int nr_tids;
-		};
-	};
+	cpumask_t cpumask;
 	struct list_head list;
 };
 
@@ -834,9 +823,9 @@ struct damon_sample_filter {
  * that to make higher access pattern picture.  It can use multiple sampling
  * primitives including page table accessed bits and page fault events.  It can
  * also filter in/out specific types of sampled access events to monitor
- * accesses of specific types, such as access-generated CPUs and threads.  This
- * struct is for controlling what sampling primitives to use (enable), and what
- * sampled access events should be filtered in/out.
+ * accesses of specific types, such as access-generated CPUs.  This struct is
+ * for controlling what sampling primitives to use (enable), and what sampled
+ * access events should be filtered in/out.
  */
 struct damon_sample_control {
 	struct damon_primitives_enabled primitives_enabled;
diff --git a/mm/damon/core.c b/mm/damon/core.c
index 782af39ef0c0..4971647d4b5e 100644
--- a/mm/damon/core.c
+++ b/mm/damon/core.c
@@ -546,10 +546,6 @@ struct damon_sample_filter *damon_new_sample_filter(
 	filter->matching = matching;
 	filter->allow = allow;
 	INIT_LIST_HEAD(&filter->list);
-	if (filter_type == DAMON_FILTER_TYPE_THREADS) {
-		filter->tid_arr = NULL;
-		filter->nr_tids = 0;
-	}
 	return filter;
 }
 
@@ -574,10 +570,6 @@ void damon_destroy_sample_filter(struct damon_sample_filter *f,
 		struct damon_sample_control *ctrl)
 {
 	damon_del_sample_filter(f, ctrl);
-	if (f->type == DAMON_FILTER_TYPE_THREADS) {
-		kfree(f->tid_arr);
-		f->nr_tids = 0;
-	}
 	damon_free_sample_filter(f);
 }
 
@@ -1325,17 +1317,6 @@ static int damon_commit_sample_filter_arg(struct damon_sample_filter *dst,
 	case DAMON_FILTER_TYPE_CPUMASK:
 		dst->cpumask = src->cpumask;
 		break;
-	case DAMON_FILTER_TYPE_THREADS:
-		if (dst->type == DAMON_FILTER_TYPE_THREADS)
-			kfree(dst->tid_arr);
-		dst->tid_arr = kmalloc_array(src->nr_tids,
-				sizeof(*dst->tid_arr), GFP_KERNEL);
-		if (!dst->tid_arr)
-			return -ENOMEM;
-		memcpy(dst->tid_arr, src->tid_arr, sizeof(*dst->tid_arr) *
-				src->nr_tids);
-		dst->nr_tids = src->nr_tids;
-		break;
 	default:
 		break;
 	}
@@ -2897,20 +2878,11 @@ static bool damon_sample_filter_matching(struct damon_access_report *report,
 		struct damon_sample_filter *filter)
 {
 	bool matched = false;
-	int i;
 
 	switch (filter->type) {
 	case DAMON_FILTER_TYPE_CPUMASK:
 		matched = cpumask_test_cpu(report->cpu, &filter->cpumask);
 		break;
-	case DAMON_FILTER_TYPE_THREADS:
-		for (i = 0; i < filter->nr_tids; i++) {
-			if (report->tid != filter->tid_arr[i])
-				continue;
-			matched = true;
-			break;
-		}
-		break;
 	default:
 		break;
 	}
-- 
2.47.3

