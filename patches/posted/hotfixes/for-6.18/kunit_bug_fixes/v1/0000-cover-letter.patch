From hackermail Thu Jan  1 00:00:00 1970
From: SeongJae Park <sj@kernel.org>
To: Andrew Morton <akpm@linux-foundation.org>
Cc: <stable@vger.kernel.org> # 5.15.x
Cc: <stable@vger.kernel.org> # 5.19.x
Cc: <stable@vger.kernel.org> # 6.1.x
Cc: <stable@vger.kernel.org> # 6.16.x
Cc: <stable@vger.kernel.org> # 6.18.x
Cc: <stable@vger.kernel.org> # 6.3.x
Cc: <stable@vger.kernel.org> # 6.5.x
Cc: <stable@vger.kernel.org> # 6.6.x
Cc: <stable@vger.kernel.org> # 6.7.x
Cc: Brendan Higgins <brendan.higgins@linux.dev>
Cc: David Gow <davidgow@google.com>
Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
Cc: Sang-Heon Jeon <ekffu200098@gmail.com>
Cc: SeongJae Park <sj@kernel.org>
Cc: damon@lists.linux.dev
Cc: kunit-dev@googlegroups.com
Cc: linux-kernel@vger.kernel.org
Cc: linux-kselftest@vger.kernel.org
Cc: linux-mm@kvack.org
Date: Sat, 1 Nov 2025 11:16:20 -0700
Subject: [PATCH 00/22] mm/damon/tests: fix memory bugs in kunit tests

DAMON kunit tests were initially written assuming those will be run on
environments that are well controlled and therefore tolerant to
transient test failures and bugs in the test code itself.  The user-mode
linux based manual run of the tests is one example of such an
environment.  And the test code was written for adding more test
coverage as fast as possible, over making those safe and reliable.

As a result, the tests resulted in having a number of bugs including
real memory leaks, theoretical unhandled memory allocation failures, and
unused memory allocations.  The allocation failures that are not handled
well are unlikely in the real world, since those allocations are too
small to fail.  But in theory, it can happen and cause inappropriate
memory access.

It is arguable if bugs in test code can really harm users.  But, anyway
bugs are bugs that need to be fixed.  Fix the bugs one by one.  Also Cc
stable@ for the fixes of memory leak and unhandled memory allocation
failures.  The unused memory allocations are only a matter of memory
efficiency, so not Cc-ing stable@.

The first patch fixes memory leaks in the test code for the DAMON core
layer.

Following fifteen, three, and one patches respectively fix unhandled
memory allocation failures in the test code for DAMON core layer,
virtual address space DAMON operation set, and DAMON sysfs interface,
one by one per test function.

Final two patches remove memory allocations that are correctly
deallocated at the end, but not really being used by any code.

SeongJae Park (22):
  mm/damon/tests/core-kunit: fix memory leak in
    damon_test_set_filters_default_reject()
  mm/damon/tests/core-kunit: handle allocation failures in
    damon_test_regions()
  mm/damon/tests/core-kunit: handle memory failure from
    damon_test_target()
  mm/damon/tests/core-kunit: handle memory alloc failure from
    damon_test_aggregate()
  mm/damon/tests/core-kunit: handle alloc failures on
    damon_test_split_at()
  mm/damon/tests/core-kunit: handle alloc failures on
    damon_test_merge_two()
  mm/damon/tests/core-kunit: handle alloc failures on
    dasmon_test_merge_regions_of()
  mm/damon/tests/core-kunit: handle alloc failures on
    damon_test_split_regions_of()
  mm/damon/tests/core-kunit: handle alloc failures in
    damon_test_ops_registration()
  mm/damon/tests/core-kunit: handle alloc failures in
    damon_test_set_regions()
  mm/damon/tests/core-kunit: handle alloc failures in
    damon_test_update_monitoring_result()
  mm/damon/tests/core-kunit: handle alloc failure on
    damon_test_set_attrs()
  mm/damon/tests/core-kunit: handle alloc failres in
    damon_test_new_filter()
  mm/damon/tests/core-kunit: handle alloc failure on
    damos_test_commit_filter()
  mm/damon/tests/core-kunit: handle alloc failures on
    damos_test_filter_out()
  mm/damon/tests/core-kunit: handle alloc failures on
    damon_test_set_filters_default_reject()
  mm/damon/tests/vaddr-kunit: handle alloc failures on
    damon_do_test_apply_three_regions()
  mm/damon/tests/vaddr-kunit: handle alloc failures in
    damon_test_split_evenly_fail()
  mm/damon/tests/vaddr-kunit: handle alloc failures on
    damon_test_split_evenly_succ()
  mm/damon/tests/sysfs-kunit: handle alloc failures on
    damon_sysfs_test_add_targets()
  mm/damon/tests/core-kunit: remove unnecessary damon_ctx variable on
    damon_test_split_at()
  mm/damon/tests/core-kunit: remove unused ctx in
    damon_test_split_regions_of()

 mm/damon/tests/core-kunit.h  | 125 ++++++++++++++++++++++++++++++++---
 mm/damon/tests/sysfs-kunit.h |  25 +++++++
 mm/damon/tests/vaddr-kunit.h |  26 +++++++-
 3 files changed, 163 insertions(+), 13 deletions(-)


base-commit: 75f0c76bb8c01fdea838a601dc3326b11177c0d8
-- 
2.47.3
